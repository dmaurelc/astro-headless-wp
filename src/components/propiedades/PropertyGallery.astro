---
interface Props {
  galeria: Array<{
    url: string;
    sizes: {
      thumbnail: string;
    };
  }>;
  title: string;
}

const { galeria, title } = Astro.props;
---

<div class="property-gallery">
  <!-- Imagen principal -->
  <div class="main-image-container mb-4">
    <div class="relative w-full h-96 md:h-[500px] overflow-hidden rounded-xl bg-muted group cursor-pointer" id="main-image-container">
      {galeria.length > 0 && (
        <img
          id="main-image"
          src={galeria[0].url}
          alt={title}
          class="w-full h-full object-cover transition-all duration-300 group-hover:scale-105"
        />
      )}
      
      <!-- Overlay para abrir modal -->
      <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
        <div class="bg-background/95 backdrop-blur-sm text-foreground border border-border px-4 py-2 rounded-full flex items-center gap-2 text-sm font-medium shadow-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
          </svg>
          Ver en pantalla completa
        </div>
      </div>
      
      <!-- Overlay con contador de imágenes -->
      <div class="absolute top-4 right-4 bg-background/80 backdrop-blur-sm text-foreground px-3 py-1 rounded-full text-sm font-medium">
        <span id="current-image">1</span> / {galeria.length}
      </div>

      <!-- Botones de navegación -->
      {galeria.length > 1 && (
        <>
          <button 
            id="prev-btn"
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-background/80 backdrop-blur-sm text-foreground p-2 rounded-full hover:bg-background transition-colors duration-200"
            aria-label="Imagen anterior"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <button 
            id="next-btn"
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-background/80 backdrop-blur-sm text-foreground p-2 rounded-full hover:bg-background transition-colors duration-200"
            aria-label="Imagen siguiente"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </>
      )}
    </div>
  </div>

  <!-- Miniaturas -->
  {galeria.length > 1 && (
    <div class="thumbnails-container">
      <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-muted-foreground/20 scrollbar-track-transparent">
        {galeria.map((imagen, index) => (
          <button
            class={`thumbnail flex-shrink-0 w-20 h-20 md:w-24 md:h-24 rounded-lg overflow-hidden border-2 transition-all duration-200 ${index === 0 ? 'border-primary' : 'border-transparent hover:border-muted-foreground/50'}`}
            data-index={index}
            data-full={imagen.url}
          >
            <img
              src={imagen.sizes.thumbnail}
              alt={`${title} - Imagen ${index + 1}`}
              class="w-full h-full object-cover"
            />
          </button>
        ))}
      </div>
    </div>
  )}
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    const mainImage = document.getElementById('main-image');
    const mainImageContainer = document.getElementById('main-image-container');
    const currentImageCounter = document.getElementById('current-image');
    const thumbnails = document.querySelectorAll('.thumbnail');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (!mainImage || !thumbnails.length) return;

    let currentIndex = 0;
    const totalImages = thumbnails.length;

    // Preparar imágenes para el modal
    const galleryImages = [];
    thumbnails.forEach(function(thumb) {
      const img = thumb.querySelector('img');
      galleryImages.push({
        url: thumb.getAttribute('data-full') || '',
        title: img ? img.alt : ''
      });
    });


    function updateImage(index) {
      const thumbnail = thumbnails[index];
      const fullUrl = thumbnail.getAttribute('data-full');
      
      if (fullUrl && mainImage) {
        mainImage.src = fullUrl;
        if (currentImageCounter) {
          currentImageCounter.textContent = (index + 1).toString();
        }
      }

      // Actualizar estados de miniaturas
      thumbnails.forEach(function(thumb, i) {
        if (i === index) {
          thumb.classList.remove('border-transparent', 'hover:border-muted-foreground/50');
          thumb.classList.add('border-primary');
        } else {
          thumb.classList.remove('border-primary');
          thumb.classList.add('border-transparent', 'hover:border-muted-foreground/50');
        }
      });

      currentIndex = index;
    }

    // Event listener para abrir modal desde imagen principal
    if (mainImageContainer) {
      mainImageContainer.addEventListener('click', function(e) {
        e.preventDefault();
        if (window.openModal && galleryImages.length > 0) {
          window.openModal(galleryImages, currentIndex);
        }
      });
    }

    // Event listeners para miniaturas
    thumbnails.forEach(function(thumbnail, index) {
      thumbnail.addEventListener('click', function(e) {
        e.preventDefault();
        updateImage(index);
      });
      
      // Doble click para abrir modal
      thumbnail.addEventListener('dblclick', function(e) {
        e.preventDefault();
        if (modal && galleryImages.length > 0) {
          modal.open(galleryImages, index);
        }
      });
    });

    // Event listeners para navegación
    if (prevBtn) {
      prevBtn.addEventListener('click', function() {
        const newIndex = currentIndex > 0 ? currentIndex - 1 : totalImages - 1;
        updateImage(newIndex);
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        const newIndex = currentIndex < totalImages - 1 ? currentIndex + 1 : 0;
        updateImage(newIndex);
      });
    }

    // Navegación con teclado (solo cuando el modal no está abierto)
    document.addEventListener('keydown', function(e) {
      const modalElement = document.getElementById('property-gallery-modal');
      const isModalOpen = modalElement && !modalElement.classList.contains('hidden');
      
      if (!isModalOpen) {
        if (e.key === 'ArrowLeft' && currentIndex > 0) {
          updateImage(currentIndex - 1);
        } else if (e.key === 'ArrowRight' && currentIndex < totalImages - 1) {
          updateImage(currentIndex + 1);
        }
      }
    });
  });
</script>

<style>
  .scrollbar-thin::-webkit-scrollbar {
    height: 6px;
  }
  
  .scrollbar-thumb-muted-foreground\/20::-webkit-scrollbar-thumb {
    background-color: rgba(148, 163, 184, 0.2);
    border-radius: 3px;
  }
  
  .scrollbar-track-transparent::-webkit-scrollbar-track {
    background: transparent;
  }
</style>