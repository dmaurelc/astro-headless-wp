---
import Layout from "../../layouts/Layout.astro";
import {
  obtenerPropiedades,
  formatearPrecio,
} from "../../services/propiedades";
import type { Propiedad } from "../../types/propiedad";

export async function getStaticPaths() {
  const propiedades = await obtenerPropiedades();

  return propiedades.map((propiedad) => ({
    params: { id: propiedad.id.toString() },
    props: { propiedad },
  }));
}

interface Props {
  propiedad: Propiedad;
}

const { propiedad } = Astro.props;
const {
  title,
  descripcion,
  precio,
  direccion,
  dormitorios,
  banos,
  estacionamientos,
  galeria,
  mapa,
  tipo,
  operacion,
} = propiedad;
---

<Layout title={`${title} | Propiedades Inmobiliarias`}>
  <!-- A√±adir estilos de Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <div class="mx-auto max-w-7xl px-4">
    <div class="my-10 py-10 grid grid-cols-1 md:grid-cols-2 gap-10">
      <div class="flex flex-col gap-4">
        <div class="w-full h-96 overflow-hidden rounded-lg">
          {
            galeria.length > 0 && (
              <img
                src={galeria[0].url}
                alt={title}
                class="w-full h-full object-cover"
              />
            )
          }
        </div>

        <div class="grid grid-cols-4 gap-2">
          {
            galeria.map((imagen, index) => (
              <div class="h-20 overflow-hidden rounded-lg cursor-pointer">
                <img
                  src={imagen.sizes.thumbnail}
                  alt={`${title} - Imagen ${index + 1}`}
                  data-full={imagen.url}
                  class="w-full h-full object-cover transition-transform duration-300 hover:scale-105 hover:opacity-80"
                />
              </div>
            ))
          }
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <div class="mb-4">
          <div class="flex gap-2 mb-2">
            {
              tipo.map((t) => (
                <span class="px-2 py-1 rounded text-xs font-light uppercase bg-primary text-white">
                  {t}
                </span>
              ))
            }
            {
              operacion.map((o) => (
                <span class="px-2 py-1 rounded text-xs font-light uppercase bg-secondary text-white ">
                  {o}
                </span>
              ))
            }
          </div>
          <h1 class="text-3xl font-bold mb-2">{title}</h1>
          <p class="text-lg mb-4">{direccion}</p>
          <p class="text-2xl font-bold text-primary">
            {formatearPrecio(precio)}
          </p>
        </div>

        <div
          class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-300"
        >
          <div class="flex items-center gap-2">
            <span class="text-lg">üõèÔ∏è</span>
            <span>{dormitorios} Dormitorios</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-lg">üöø</span>
            <span>{banos} Ba√±os</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-lg">üöó</span>
            <span>{estacionamientos} Estacionamientos</span>
          </div>
        </div>

        <div class="mb-4 leading-relaxed" set:html={descripcion} />

        <div class="mb-4">
          <h2 class="text-lg font-bold mb-2">Ubicaci√≥n</h2>
          <p>{direccion}</p>
          {
            mapa && mapa.lat && mapa.lng && (
              <div class="h-96 bg-gray-50 rounded-lg border border-gray-300 overflow-hidden">
                <div id="mapa-propiedad" class="w-full h-full" data-lat={mapa.lat} data-lng={mapa.lng} data-direccion={direccion}></div>
                <script is:inline>
                  // Inicializar el mapa una vez que el DOM est√© cargado
                  document.addEventListener('DOMContentLoaded', function() {
                    const mapaElement = document.getElementById('mapa-propiedad');
                    
                    if (mapaElement) {
                      const lat = parseFloat(mapaElement.getAttribute('data-lat') || '0');
                      const lng = parseFloat(mapaElement.getAttribute('data-lng') || '0');
                      const direccion = mapaElement.getAttribute('data-direccion') || '';
                      
                      // Verificar que Leaflet est√© disponible
                      if (typeof L !== 'undefined') {
                        // Crear el mapa centrado en las coordenadas de la propiedad
                        const map = L.map('mapa-propiedad').setView([lat, lng], 15);
                        
                        // A√±adir la capa de OpenStreetMap
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);
                        
                        // A√±adir un marcador en la ubicaci√≥n de la propiedad
                        L.marker([lat, lng])
                          .addTo(map)
                          .bindPopup(direccion)
                          .openPopup();
                      } else {
                        console.error('Leaflet no est√° disponible');
                      }
                    }
                  });
                </script>
              </div>
            )
          }
        </div>

        <div class="flex gap-4">
          <a href="/" class="btn-primary">Volver al inicio</a>
          <a href="/contacto" class="btn-primary-outline">Contactar</a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Script para cambiar la imagen principal al hacer clic en una miniatura
  document.addEventListener("DOMContentLoaded", () => {
    const miniaturas = document.querySelectorAll(".miniatura img");
    const imagenPrincipal = document.querySelector(
      ".imagen-destacada",
    ) as HTMLImageElement;

    if (miniaturas && imagenPrincipal) {
      miniaturas.forEach((miniatura) => {
        miniatura.addEventListener("click", () => {
          const fullUrl = miniatura.getAttribute("data-full");
          if (fullUrl) {
            imagenPrincipal.src = fullUrl;
          }
        });
      });
    }
  });
</script>
